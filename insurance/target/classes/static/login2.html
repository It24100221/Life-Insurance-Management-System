<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insurance System - Login & Register</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
        }

        .container {
            max-width: 450px;
            width: 100%;
            padding: 20px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            margin: 0 5px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #fff;
            color: #1e3c72;
        }

        .form-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0 12px 12px 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .form {
            display: none;
        }

        .form.active {
            display: block;
        }

        .success-message {
            display: none;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .input-group {
            margin-bottom: 20px;
            position: relative;
        }

        input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            color: #fff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #fff;
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.15);
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            width: 24px;
            height: 24px;
            background: url('https://img.icons8.com/ios/24/ffffff/visible.png') no-repeat center;
            opacity: 0.7;
        }

        .toggle-password.showing {
            background: url('https://img.icons8.com/ios/24/ffffff/invisible.png') no-repeat center;
        }

        button {
            width: 100%;
            padding: 14px;
            background: #fff;
            border: none;
            border-radius: 8px;
            color: #1e3c72;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover:not(:disabled) {
            background: #f0f0f0;
            transform: translateY(-2px);
        }

        button.loading {
            position: relative;
            color: transparent;
        }

        button.loading::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid #1e3c72;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .switch {
            text-align: center;
            margin-top: 20px;
        }

        .switch a {
            color: #fff;
            text-decoration: none;
            font-weight: 600;
        }

        .switch a:hover {
            text-decoration: underline;
        }

        .terms {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .terms input {
            width: auto;
            margin: 0;
        }

        .terms label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        .input-group .error-text {
            display: block;
            margin-top: 8px;
            font-size: 12.5px;
            font-weight: 700;
            color: #fff;
            background: rgba(244, 67, 54, 0.18);
            border: 1px solid #f44336;
            padding: 8px 10px;
            border-radius: 8px;
            line-height: 1.3;
        }

        .input-group.has-error input {
            border-color: #f44336 !important;
            box-shadow: 0 0 0 4px rgba(244, 67, 54, 0.15) !important;
        }

        @keyframes spin {
            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="tabs">
        <div class="tab active" data-tab="login">Login</div>
        <div class="tab" data-tab="register">Register</div>
    </div>
    <div class="form-container">
        <div class="success-message" id="successMessage"></div>
        <form id="loginForm" class="form active">
            <h2>Login to Your Account</h2>
            <div class="input-group">
                <input type="email" placeholder="Email Address" required>
            </div>
            <div class="input-group">
                <input type="password" placeholder="Password" required>
                <span class="toggle-password"></span>
            </div>
            <button type="submit">Login</button>
            <div class="switch">
                Don't have an account? <a href="#" class="switch-to-register">Register</a>
            </div>
        </form>
        <form id="registerForm" class="form">
            <h2>Create an Account</h2>
            <div class="input-group">
                <input type="text" placeholder="Full Name" required>
            </div>
            <div class="input-group">
                <input type="email" placeholder="Email Address" required>
            </div>
            <div class="input-group">
                <input type="text" placeholder="NIC Number" required>
            </div>
            <div class="input-group">
                <input type="tel" placeholder="Phone Number" required>
            </div>
            <div class="input-group">
                <input type="password" placeholder="Password" required>
                <span class="toggle-password"></span>
            </div>
            <div class="input-group">
                <input type="password" placeholder="Confirm Password" required>
                <span class="toggle-password"></span>
            </div>
            <div class="terms">
                <input type="checkbox" id="terms">
                <label for="terms">I agree to the Terms & Conditions</label>
            </div>
            <button type="submit">Register</button>
            <div class="switch">
                Already have an account? <a href="#" class="switch-to-login">Login</a>
            </div>
        </form>
    </div>
</div>
<script>
    (function () {
        'use strict';

        // ---- CONFIG ----
        const API_BASE = 'http://localhost:9091';
        const REDIRECTS = {
            'user': '/profile.html',
            'claim officer': '/claim.html',
            'agent': '/payment.html',
            'support staff': '/profile.html',
            'system auditor': '/auditor.html'
        };

        // ---- Helpers ----
        const qs = (sel, scope = document) => scope.querySelector(sel);
        const qsa = (sel, scope = document) => Array.from(scope.querySelectorAll(sel));

        const successMessage = qs('#successMessage');

        function showForm(tab) {
            document.querySelectorAll('.form').forEach(f => f.classList.remove('active'));
            document.getElementById(tab + 'Form').classList.add('active');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
            hideGlobalMessage();
        }

        function setButtonLoading(btn, isLoading) {
            if (!btn) return;
            if (isLoading) {
                btn.classList.add('loading');
                btn.disabled = true;
            } else {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        function showGlobalMessage(text, type = 'success') {
            if (!successMessage) return;
            successMessage.style.display = 'block';
            if (type === 'success') {
                successMessage.style.background = 'rgba(76, 175, 80, 0.16)';
                successMessage.style.border = '1px solid #4caf50';
                successMessage.style.color = '#ffffff';
            } else {
                successMessage.style.background = 'rgba(244, 67, 54, 0.18)';
                successMessage.style.border = '1px solid #f44336';
                successMessage.style.color = '#fff';
            }
            successMessage.textContent = text;
        }

        function hideGlobalMessage() {
            if (!successMessage) return;
            successMessage.style.display = 'none';
        }

        function clearFieldError(input) {
            const ig = input.closest('.input-group');
            if (!ig) return;
            ig.classList.remove('has-error');
            const err = ig.querySelector('.error-text');
            if (err) err.remove();
        }

        function setFieldError(input, message) {
            const ig = input.closest('.input-group');
            if (!ig) return;
            ig.classList.add('has-error');
            let err = ig.querySelector('.error-text');
            if (!err) {
                err = document.createElement('small');
                err.className = 'error-text';
                err.setAttribute('role', 'alert');
                err.setAttribute('aria-live', 'polite');
                ig.appendChild(err);
            }
            err.textContent = message;
        }

        function sanitize(str) {
            return (str || '').toString().trim();
        }

        // ---- Validators ----
        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(email);
        }

        function passwordStrength(password) {
            const errors = [];
            if (password.length < 8) errors.push('At least 8 characters');
            if (!/[a-z]/.test(password)) errors.push('One lowercase letter');
            if (!/[A-Z]/.test(password)) errors.push('One uppercase letter');
            if (!/[0-9]/.test(password)) errors.push('One number');
            if (!/[!@#$%^&*()_\-+=[\]{};:\'",.<>/?\\|`~]/.test(password)) errors.push('One special character');
            return { valid: errors.length === 0, errors };
        }

        function isValidFullName(name) {
            return /^[A-Za-z][A-Za-z\s'\-]{1,59}$/.test(name);
        }

        function isValidNIC(nic) {
            return /^(\d{9}[VvXx]|\d{12})$/.test(nic);
        }

        function isValidPhone(phone) {
            return /^\+?\d{10,15}$/.test(phone.replace(/\s+/g, ''));
        }

        function validateLoginForm() {
            const emailEl = qs('#loginForm input[type="email"]');
            const pwEl = qs('#loginForm input[type="password"]');
            let ok = true;

            const email = sanitize(emailEl.value);
            const password = sanitize(pwEl.value);

            clearFieldError(emailEl);
            clearFieldError(pwEl);

            if (!isValidEmail(email)) {
                setFieldError(emailEl, 'Please enter a valid email address.');
                ok = false;
            }
            if (!password) {
                setFieldError(pwEl, 'Password is required.');
                ok = false;
            }
            return { ok, values: { email, password } };
        }

        function validateRegisterForm() {
            const fullNameEl = qs('#registerForm input[placeholder="Full Name"]');
            const emailEl = qs('#registerForm input[placeholder="Email Address"]');
            const nicEl = qs('#registerForm input[placeholder="NIC Number"]');
            const phoneEl = qs('#registerForm input[placeholder="Phone Number"]');
            const pwEl = qs('#registerForm input[placeholder="Password"]');
            const confirmEl = qs('#registerForm input[placeholder="Confirm Password"]');
            const termsEl = qs('#terms');

            let ok = true;

            const fullName = sanitize(fullNameEl.value);
            const email = sanitize(emailEl.value);
            const nicNumber = sanitize(nicEl.value);
            const phoneNumber = sanitize(phoneEl.value);
            const password = sanitize(pwEl.value);
            const confirmPassword = sanitize(confirmEl.value);
            const terms = !!termsEl.checked;

            [fullNameEl, emailEl, nicEl, phoneEl, pwEl, confirmEl].forEach(clearFieldError);

            if (!isValidFullName(fullName)) {
                setFieldError(fullNameEl, 'Enter your full name (letters only, 2–60 chars).');
                ok = false;
            }
            if (!isValidEmail(email)) {
                setFieldError(emailEl, 'Please enter a valid email address.');
                ok = false;
            }
            if (!isValidNIC(nicNumber)) {
                setFieldError(nicEl, 'NIC must be 9 digits + V/X or 12 digits.');
                ok = false;
            }
            if (!isValidPhone(phoneNumber)) {
                setFieldError(phoneEl, 'Phone must be 10–15 digits.');
                ok = false;
            }
            const pwCheck = passwordStrength(password);
            if (!pwCheck.valid) {
                setFieldError(pwEl, `Password needs: ${pwCheck.errors.join(', ')}.`);
                ok = false;
            }
            if (confirmPassword !== password) {
                setFieldError(confirmEl, 'Passwords do not match.');
                ok = false;
            }
            if (!terms) {
                showGlobalMessage('You must agree to the Terms & Conditions.', 'error');
                ok = false;
            } else {
                hideGlobalMessage();
            }

            return { ok, values: { fullName, email, nicNumber, phoneNumber, password, confirmPassword, terms } };
        }

        // ---- Tabs ----
        qsa('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                showForm(tab.getAttribute('data-tab'));
            });
        });

        qs('.switch-to-register').addEventListener('click', (e) => {
            e.preventDefault();
            showForm('register');
        });

        qs('.switch-to-login').addEventListener('click', (e) => {
            e.preventDefault();
            showForm('login');
        });

        // ---- Password toggle ----
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.toggle-password');
            if (!btn) return;
            const input = btn.parentElement.querySelector('input[type="password"], input[type="text"]');
            if (!input) return;
            input.type = input.type === 'password' ? 'text' : 'password';
            btn.classList.toggle('showing');
        });

        // ---- Login submit ----
        const loginFormEl = qs('#loginForm');
        loginFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();

            hideGlobalMessage();
            const { ok, values } = validateLoginForm();
            const loginBtn = qs('#loginForm button[type="submit"]');

            if (!ok) {
                showGlobalMessage('Please fix the highlighted fields.', 'error');
                return;
            }

            setButtonLoading(loginBtn, true);

            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(values)
                });
                const data = await response.json().catch(() => ({}));

                if (response.ok && data.message.includes('successful')) {
                    showGlobalMessage('Login successful! Redirecting...', 'success');
                    const redirectUrl = REDIRECTS[data.role] || '/profile.html';
                    setTimeout(() => { window.location.href = redirectUrl; }, 1200);
                } else {
                    showGlobalMessage(data.message || 'Login failed. Check your credentials.', 'error');
                }
            } catch (err) {
                showGlobalMessage('Network error. Try again later.', 'error');
            } finally {
                setButtonLoading(loginBtn, false);
            }
        });

        // ---- Register submit ----
        const registerFormEl = qs('#registerForm');
        registerFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();

            hideGlobalMessage();
            const { ok, values } = validateRegisterForm();
            const registerBtn = qs('#registerForm button[type="submit"]');

            if (!ok) {
                if (successMessage.style.display !== 'block') {
                    showGlobalMessage('Please fix the highlighted fields.', 'error');
                }
                return;
            }

            setButtonLoading(registerBtn, true);

            try {
                const response = await fetch(`${API_BASE}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(values)
                });
                const data = await response.json().catch(() => ({}));

                if (response.ok && data.message.includes('successful')) {
                    showGlobalMessage('Registration successful! Please log in.', 'success');
                    setTimeout(() => showForm('login'), 1200);
                } else {
                    showGlobalMessage(data.message || 'Registration failed. Try again.', 'error');
                }
            } catch (err) {
                showGlobalMessage('Network error. Try again later.', 'error');
            } finally {
                setButtonLoading(registerBtn, false);
            }
        });

        // ---- Real-time validation ----
        qsa('#loginForm input').forEach(input => {
            input.addEventListener('input', () => {
                if (input.type === 'email') {
                    clearFieldError(input);
                    if (input.value && !isValidEmail(sanitize(input.value))) {
                        setFieldError(input, 'Please enter a valid email address.');
                    }
                } else if (input.type === 'password') {
                    clearFieldError(input);
                    if (!sanitize(input.value)) {
                        setFieldError(input, 'Password is required.');
                    }
                }
            });
        });

        qsa('#registerForm input:not([type="checkbox"])').forEach(input => {
            input.addEventListener('input', () => {
                const ph = input.getAttribute('placeholder') || '';
                clearFieldError(input);
                const val = sanitize(input.value);

                if (ph === 'Full Name' && val && !isValidFullName(val)) {
                    setFieldError(input, 'Enter your full name (letters only, 2–60 chars).');
                }
                if (ph === 'Email Address' && val && !isValidEmail(val)) {
                    setFieldError(input, 'Please enter a valid email address.');
                }
                if (ph === 'NIC Number' && val && !isValidNIC(val)) {
                    setFieldError(input, 'NIC must be 9 digits + V/X or 12 digits.');
                }
                if (ph === 'Phone Number' && val && !isValidPhone(val)) {
                    setFieldError(input, 'Phone must be 10–15 digits.');
                }
                if (ph === 'Password') {
                    const check = passwordStrength(val);
                    if (val && !check.valid) {
                        setFieldError(input, `Password needs: ${check.errors.join(', ')}.`);
                    }
                    const confirmEl = qs('#registerForm input[placeholder="Confirm Password"]');
                    if (confirmEl && sanitize(confirmEl.value) && sanitize(confirmEl.value) !== val) {
                        setFieldError(confirmEl, 'Passwords do not match.');
                    } else if (confirmEl) {
                        clearFieldError(confirmEl);
                    }
                }
                if (ph === 'Confirm Password') {
                    const pwEl = qs('#registerForm input[placeholder="Password"]');
                    if (pwEl && val && val !== sanitize(pwEl.value)) {
                        setFieldError(input, 'Passwords do not match.');
                    }
                }
            });
        });

        // ---- Initialize login form ----
        showForm('login');
    })();
</script>
</body>
</html>