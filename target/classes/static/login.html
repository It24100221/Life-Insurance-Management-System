<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOTALCARE - Login & Register</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Professional Blue Theme */
            --primary-blue: #1e3a8a;
            --primary-blue-light: #3b82f6;
            --primary-blue-dark: #1e40af;
            --accent-gold: #d97706;
            --accent-gold-light: #f59e0b;

            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --dark-card-light: #334155;
            --dark-text: #f8fafc;
            --dark-text-light: #cbd5e1;
            --dark-accent: var(--primary-blue-light);
            --dark-accent-2: #60a5fa;
            --dark-accent-dark: var(--primary-blue-dark);
            --dark-accent-soft: #93c5fd;

            --light: #334155;
            --white: #334155;
            --dark: #f8fafc;
            --text: #f1f5f9;
            --text-light: #cbd5e1;

            --shadow: 0 10px 25px rgba(0, 0, 0, 0.20);
            --shadow-md: 0 14px 30px rgba(0, 0, 0, 0.25);
            --shadow-lg: 0 22px 45px rgba(0, 0, 0, 0.30);
            --glow: 0 10px 25px rgba(59, 130, 246, 0.25);

            --transition: all .3s ease;
            --radius: 18px;
            --radius-lg: 22px;

            /* Light mode variables */
            --bg-primary: var(--dark-bg);
            --bg-secondary: var(--dark-card);
            --text-primary: var(--dark-text);
            --text-secondary: var(--dark-text-light);
            --border-color: #334155;
        }

        .dark-mode {
            /* Dark mode variables */
            --bg-primary: var(--dark-bg);
            --bg-secondary: var(--dark-card);
            --text-primary: var(--dark-text);
            --text-secondary: var(--dark-text-light);
            --border-color: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            color: var(--text-primary);
            line-height: 1.6;
            background: var(--bg-primary);
            transition: var(--transition);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(1200px 500px at -10% -10%, rgba(59, 130, 246, 0.08), transparent 60%),
            radial-gradient(1200px 500px at 110% -10%, rgba(51, 65, 85, 0.10), transparent 60%),
            linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-primary) 100%);
        }

        /* Header Logo */
        .header-logo {
            position: fixed;
            top: 30px;
            left: 30px;
            z-index: 1000;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            letter-spacing: .3px;
            color: var(--dark-accent);
            text-decoration: none;
            transition: var(--transition);
            padding: 12px 18px;
            border-radius: 16px;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .logo i {
            margin-right: 12px;
            color: var(--accent-gold-light);
            filter: drop-shadow(0 4px 10px rgba(245, 158, 11, 0.25));
        }

        .logo:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            color: var(--dark-accent-2);
        }

        .container {
            max-width: 500px;
            width: 100%;
            padding: 30px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }

        .tab {
            padding: 16px 32px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 16px 16px 0 0;
            cursor: pointer;
            margin: 0 8px;
            font-weight: 700;
            transition: var(--transition);
            color: var(--text-primary);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .tab.active {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95));
            color: var(--dark-accent);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }

        .form-container {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            border-radius: 0 var(--radius-lg) var(--radius-lg) var(--radius-lg);
            padding: 40px;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
            border: 1px solid rgba(59, 130, 246, 0.2);
            backdrop-filter: blur(10px);
        }

        .form {
            display: none;
        }

        .form.active {
            display: block;
        }

        .success-message {
            display: none;
            padding: 18px;
            margin-bottom: 25px;
            border-radius: var(--radius);
            text-align: center;
            font-weight: 700;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            color: rgb(74, 222, 128);
            backdrop-filter: blur(5px);
        }

        h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            font-family: 'Playfair Display', serif;
            color: var(--text-primary);
            background: linear-gradient(90deg, var(--dark-accent), var(--dark-accent-2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .input-group {
            margin-bottom: 25px;
            position: relative;
        }

        input {
            width: 100%;
            padding: 18px 50px 18px 20px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: rgba(30, 41, 59, 0.7);
            color: var(--text-primary);
            font-size: 16px;
            transition: var(--transition);
            font-family: 'Montserrat', sans-serif;
            backdrop-filter: blur(5px);
        }

        input:focus {
            outline: none;
            border-color: var(--dark-accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, .15);
            background: rgba(30, 41, 59, 0.9);
        }

        input::placeholder {
            color: var(--text-secondary);
        }

        .toggle-password {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            width: 28px;
            height: 28px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23cbd5e1"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>') no-repeat center;
            opacity: 0.7;
            transition: var(--transition);
        }

        .toggle-password:hover {
            opacity: 1;
        }

        .toggle-password.showing {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23cbd5e1"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>') no-repeat center;
        }

        button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--dark-accent) 0%, var(--dark-accent-dark) 100%);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Montserrat', sans-serif;
            box-shadow: var(--glow);
            position: relative;
            overflow: hidden;
            margin-top: 10px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        button.loading {
            position: relative;
            color: transparent;
        }

        button.loading::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .switch {
            text-align: center;
            margin-top: 25px;
            color: var(--text-secondary);
            font-size: 15px;
        }

        .switch a {
            color: var(--dark-accent);
            text-decoration: none;
            font-weight: 700;
            transition: var(--transition);
        }

        .switch a:hover {
            text-decoration: underline;
            color: var(--dark-accent-2);
        }

        .terms {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .terms input {
            width: auto;
            margin: 4px 0 0 0;
        }

        .terms label {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .input-group .error-text {
            display: block;
            margin-top: 10px;
            font-size: 13px;
            font-weight: 700;
            color: #fff;
            background: rgba(244, 67, 54, 0.18);
            border: 1px solid #f44336;
            padding: 10px 12px;
            border-radius: 8px;
            line-height: 1.4;
        }

        .input-group.has-error input {
            border-color: #f44336 !important;
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.15) !important;
        }

        .dev-mode-toggle {
            position: fixed;
            top: 30px;
            right: 30px;
            background: linear-gradient(135deg, var(--dark-accent), var(--dark-accent-dark));
            border: none;
            border-radius: 50%;
            width: 55px;
            height: 55px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            transition: var(--transition);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
        }

        .dev-mode-toggle:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg), var(--glow);
        }

        .dev-panel {
            position: fixed;
            top: 100px;
            right: 30px;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95));
            border-radius: var(--radius-lg);
            padding: 25px;
            width: 380px;
            display: none;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(59, 130, 246, 0.2);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .dev-panel h3 {
            margin-bottom: 20px;
            text-align: center;
            font-size: 20px;
            color: var(--text-primary);
            font-family: 'Playfair Display', serif;
            background: linear-gradient(90deg, var(--dark-accent), var(--dark-accent-2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .dev-account {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .dev-account:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .dev-account .role {
            font-weight: 700;
            width: 130px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .dev-account .credentials {
            font-size: 13px;
            text-align: right;
            color: var(--text-secondary);
            flex: 1;
            margin: 0 12px;
        }

        .dev-account .quick-login {
            background: linear-gradient(135deg, var(--dark-accent) 0%, var(--dark-accent-dark) 100%);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 8px 14px;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            font-weight: 600;
        }

        .dev-account .quick-login:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Dark Mode Toggle */
        .dark-mode-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, var(--dark-accent), var(--dark-accent-dark));
            color: #fff;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
        }

        .dark-mode-toggle:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg), var(--glow);
        }

        @keyframes spin {
            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        /* Error message styling */
        .error-message {
            display: none;
            padding: 18px;
            margin-bottom: 25px;
            border-radius: var(--radius);
            text-align: center;
            font-weight: 700;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: rgb(248, 113, 113);
            backdrop-filter: blur(5px);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header-logo {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 30px;
                display: flex;
                justify-content: center;
            }

            .logo {
                font-size: 1.8rem;
                padding: 10px 15px;
            }

            .container {
                padding: 20px;
                max-width: 450px;
            }

            .form-container {
                padding: 30px;
            }

            .dev-panel {
                width: 90%;
                right: 5%;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .form-container {
                padding: 25px;
            }

            .tab {
                padding: 14px 24px;
                font-size: 1rem;
            }

            input {
                padding: 16px 45px 16px 16px;
            }
        }
    </style>
</head>
<body class="dark-mode">
<!-- SecureLife Logo -->
<div class="header-logo">
    <a class="logo" href="home.html" aria-label="TOTALCARE Home">
        <i class="fas fa-shield-alt"></i>
        <span>TOTALCARE</span>
    </a>
</div>

<div class="container">
    <div class="tabs">
        <div class="tab active" data-tab="login">Login</div>
        <div class="tab" data-tab="register">Register</div>
    </div>
    <div class="form-container">
        <div class="success-message" id="successMessage"></div>
        <div class="error-message" id="errorMessage"></div>
        <form id="loginForm" class="form active">
            <h2>Login to Your Account</h2>
            <div class="input-group">
                <input type="email" placeholder="Email Address" required>
            </div>
            <div class="input-group">
                <input type="password" placeholder="Password" required>
                <span class="toggle-password"></span>
            </div>
            <button type="submit">Login</button>
            <div class="switch">
                Don't have an account? <a href="#" class="switch-to-register">Register</a>
            </div>
        </form>
        <form id="registerForm" class="form">
            <h2>Create an Account</h2>
            <div class="input-group">
                <input type="text" placeholder="Full Name" required>
            </div>
            <div class="input-group">
                <input type="email" placeholder="Email Address" required>
            </div>
            <div class="input-group">
                <input type="text" placeholder="NIC Number" required>
            </div>
            <div class="input-group">
                <input type="tel" placeholder="Phone Number" required>
            </div>
            <div class="input-group">
                <input type="password" placeholder="Password" required>
                <span class="toggle-password"></span>
            </div>
            <div class="input-group">
                <input type="password" placeholder="Confirm Password" required>
                <span class="toggle-password"></span>
            </div>
            <div class="terms">
                <input type="checkbox" id="terms">
                <label for="terms">I agree to the Terms & Conditions</label>
            </div>
            <button type="submit">Register</button>
            <div class="switch">
                Already have an account? <a href="#" class="switch-to-login">Login</a>
            </div>
        </form>
    </div>
</div>

<!-- Hidden developer panel for stakeholders -->
<button class="dev-mode-toggle" id="devModeToggle">⚙️</button>
<div class="dev-panel" id="devPanel">
    <h3>Stakeholder Accounts</h3>
    <div class="dev-account">
        <div class="role">Admin</div>
        <div class="credentials">admin@gmail.com / admin123</div>
        <button class="quick-login" data-email="admin@gmail.com" data-password="admin123">Login</button>
    </div>
    <div class="dev-account">
        <div class="role">Support Staff</div>
        <div class="credentials">support@gmail.com / support123</div>
        <button class="quick-login" data-email="support@gmail.com" data-password="support123">Login</button>
    </div>
    <div class="dev-account">
        <div class="role">System Auditor</div>
        <div class="credentials">auditor@gmail.com / auditor123</div>
        <button class="quick-login" data-email="auditor@gmail.com" data-password="auditor123">Login</button>
    </div>
    <div class="dev-account">
        <div class="role">Claim Officer</div>
        <div class="credentials">claim@gmail.com / claim123</div>
        <button class="quick-login" data-email="claim@gmail.com" data-password="claim123">Login</button>
    </div>
    <div class="dev-account">
        <div class="role">Agent</div>
        <div class="credentials">agent@gmail.com / agent123</div>
        <button class="quick-login" data-email="agent@gmail.com" data-password="agent123">Login</button>
    </div>
</div>

<!-- Dark Mode Toggle -->
<button class="dark-mode-toggle" id="darkModeToggle" aria-label="Toggle Dark Mode">
    <i class="fas fa-moon" id="darkModeIcon"></i>
</button>

<script>
    (function () {
        'use strict';

        // ---- CONFIG ----
        const API_BASE = 'http://localhost:9091';
        const REDIRECTS = {
            'user': 'profile.html',
            'customer': 'profile.html',
            'claim officer': 'claim_officer.html',
            'agent': 'agent.html',
            'support staff': 'staff.html',
            'system auditor': 'feedback.html',
            'admin': 'admin.html'
        };

        // Predefined credentials for stakeholders
        const PREDEFINED_CREDENTIALS = {
            'admin@gmail.com': { password: 'admin123', role: 'admin' },
            'support@gmail.com': { password: 'support123', role: 'support staff' },
            'auditor@gmail.com': { password: 'auditor123', role: 'system auditor' },
            'claim@gmail.com': { password: 'claim123', role: 'claim officer' },
            'agent@gmail.com': { password: 'agent123', role: 'agent' }
        };

        // ---- Helpers ----
        const qs = (sel, scope = document) => scope.querySelector(sel);
        const qsa = (sel, scope = document) => Array.from(scope.querySelectorAll(sel));

        const successMessage = qs('#successMessage');
        const errorMessage = qs('#errorMessage');
        const devModeToggle = qs('#devModeToggle');
        const devPanel = qs('#devPanel');
        const darkModeToggle = qs('#darkModeToggle');
        const darkModeIcon = qs('#darkModeIcon');

        function showForm(tab) {
            document.querySelectorAll('.form').forEach(f => f.classList.remove('active'));
            document.getElementById(tab + 'Form').classList.add('active');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
            hideGlobalMessage();
        }

        function setButtonLoading(btn, isLoading) {
            if (!btn) return;
            if (isLoading) {
                btn.classList.add('loading');
                btn.disabled = true;
            } else {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        function showGlobalMessage(text, type = 'success') {
            if (type === 'success') {
                successMessage.style.display = 'block';
                errorMessage.style.display = 'none';
                successMessage.textContent = text;
            } else {
                errorMessage.style.display = 'block';
                successMessage.style.display = 'none';
                errorMessage.textContent = text;
            }
        }

        function hideGlobalMessage() {
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
        }

        function clearFieldError(input) {
            const ig = input.closest('.input-group');
            if (!ig) return;
            ig.classList.remove('has-error');
            const err = ig.querySelector('.error-text');
            if (err) err.remove();
        }

        function setFieldError(input, message) {
            const ig = input.closest('.input-group');
            if (!ig) return;
            ig.classList.add('has-error');
            let err = ig.querySelector('.error-text');
            if (!err) {
                err = document.createElement('small');
                err.className = 'error-text';
                err.setAttribute('role', 'alert');
                err.setAttribute('aria-live', 'polite');
                ig.appendChild(err);
            }
            err.textContent = message;
        }

        function sanitize(str) {
            return (str || '').toString().trim();
        }

        // ---- Validators ----
        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(email);
        }

        function passwordStrength(password) {
            const errors = [];
            if (password.length < 4) errors.push('At least 4 characters');
            return { valid: errors.length === 0, errors };
        }

        function isValidFullName(name) {
            return /^[A-Za-z][A-Za-z\s'\-]{1,59}$/.test(name);
        }

        function isValidNIC(nic) {
            return /^(\d{9}[VvXx]|\d{12})$/.test(nic);
        }

        function isValidPhone(phone) {
            return /^\+?\d{10,15}$/.test(phone.replace(/\s+/g, ''));
        }

        function validateLoginForm() {
            const emailEl = qs('#loginForm input[type="email"]');
            const pwEl = qs('#loginForm input[type="password"]');
            let ok = true;

            const email = sanitize(emailEl.value);
            const password = sanitize(pwEl.value);

            clearFieldError(emailEl);
            clearFieldError(pwEl);

            if (!isValidEmail(email)) {
                setFieldError(emailEl, 'Please enter a valid email address.');
                ok = false;
            }
            if (!password) {
                setFieldError(pwEl, 'Password is required.');
                ok = false;
            }
            return { ok, values: { email, password } };
        }

        function validateRegisterForm() {
            const fullNameEl = qs('#registerForm input[placeholder="Full Name"]');
            const emailEl = qs('#registerForm input[placeholder="Email Address"]');
            const nicEl = qs('#registerForm input[placeholder="NIC Number"]');
            const phoneEl = qs('#registerForm input[placeholder="Phone Number"]');
            const pwEl = qs('#registerForm input[placeholder="Password"]');
            const confirmEl = qs('#registerForm input[placeholder="Confirm Password"]');
            const termsEl = qs('#terms');

            let ok = true;

            const fullName = sanitize(fullNameEl.value);
            const email = sanitize(emailEl.value);
            const nic = sanitize(nicEl.value);
            const phone = sanitize(phoneEl.value);
            const password = sanitize(pwEl.value);
            const confirmPassword = sanitize(confirmEl.value);
            const terms = !!termsEl.checked;

            [fullNameEl, emailEl, nicEl, phoneEl, pwEl, confirmEl].forEach(clearFieldError);

            if (!isValidFullName(fullName)) {
                setFieldError(fullNameEl, 'Enter your full name (letters only, 2–60 chars).');
                ok = false;
            }
            if (!isValidEmail(email)) {
                setFieldError(emailEl, 'Please enter a valid email address.');
                ok = false;
            }
            if (!isValidNIC(nic)) {
                setFieldError(nicEl, 'NIC must be 9 digits + V/X or 12 digits.');
                ok = false;
            }
            if (!isValidPhone(phone)) {
                setFieldError(phoneEl, 'Phone must be 10–15 digits.');
                ok = false;
            }
            const pwCheck = passwordStrength(password);
            if (!pwCheck.valid) {
                setFieldError(pwEl, `Password needs: ${pwCheck.errors.join(', ')}.`);
                ok = false;
            }
            if (confirmPassword !== password) {
                setFieldError(confirmEl, 'Passwords do not match.');
                ok = false;
            }
            if (!terms) {
                showGlobalMessage('You must agree to the Terms & Conditions.', 'error');
                ok = false;
            } else {
                hideGlobalMessage();
            }

            return { ok, values: { fullName, email, nic, phone, password, confirmPassword, terms } };
        }

        // ---- Tabs ----
        qsa('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                showForm(tab.getAttribute('data-tab'));
            });
        });

        qs('.switch-to-register').addEventListener('click', (e) => {
            e.preventDefault();
            showForm('register');
        });

        qs('.switch-to-login').addEventListener('click', (e) => {
            e.preventDefault();
            showForm('login');
        });

        // ---- Password toggle ----
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.toggle-password');
            if (!btn) return;
            const input = btn.parentElement.querySelector('input[type="password"], input[type="text"]');
            if (!input) return;
            input.type = input.type === 'password' ? 'text' : 'password';
            btn.classList.toggle('showing');
        });

        // ---- Developer panel toggle ----
        devModeToggle.addEventListener('click', () => {
            devPanel.style.display = devPanel.style.display === 'block' ? 'none' : 'block';
        });

        // ---- Quick login for stakeholders ----
        qsa('.quick-login').forEach(btn => {
            btn.addEventListener('click', () => {
                const email = btn.getAttribute('data-email');
                const password = btn.getAttribute('data-password');

                // Fill the login form
                const emailInput = qs('#loginForm input[type="email"]');
                const passwordInput = qs('#loginForm input[type="password"]');

                emailInput.value = email;
                passwordInput.value = password;

                // Submit the form
                qs('#loginForm button[type="submit"]').click();
            });
        });

        // ---- Dark Mode Toggle ----
        darkModeToggle.addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');

            if (document.body.classList.contains('dark-mode')) {
                darkModeIcon.classList.remove('fa-moon');
                darkModeIcon.classList.add('fa-sun');
                localStorage.setItem('darkMode', 'enabled');
            } else {
                darkModeIcon.classList.remove('fa-sun');
                darkModeIcon.classList.add('fa-moon');
                localStorage.setItem('darkMode', 'disabled');
            }
        });

        // Check for saved dark mode preference
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
            darkModeIcon.classList.remove('fa-moon');
            darkModeIcon.classList.add('fa-sun');
        }

        // ---- Login submit ----
        const loginFormEl = qs('#loginForm');
        loginFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();

            hideGlobalMessage();
            const { ok, values } = validateLoginForm();
            const loginBtn = qs('#loginForm button[type="submit"]');

            if (!ok) {
                showGlobalMessage('Please fix the highlighted fields.', 'error');
                return;
            }

            setButtonLoading(loginBtn, true);

            try {
                // Check if it's a predefined credential
                if (PREDEFINED_CREDENTIALS[values.email] &&
                    PREDEFINED_CREDENTIALS[values.email].password === values.password) {

                    const predefinedUser = PREDEFINED_CREDENTIALS[values.email];
                    showGlobalMessage('Login successful! Redirecting...', 'success');

                    // Store user data in localStorage
                    localStorage.setItem('userData', JSON.stringify({
                        email: values.email,
                        role: predefinedUser.role,
                        message: 'Login successful'
                    }));

                    // Redirect based on role
                    const userRole = predefinedUser.role.toLowerCase();
                    const redirectUrl = REDIRECTS[userRole] || 'profile.html';
                    setTimeout(() => { window.location.href = redirectUrl; }, 1200);
                } else {
                    // Regular login flow
                    const response = await fetch(`${API_BASE}/api/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(values)
                    });
                    const data = await response.json().catch(() => ({}));

                    if (response.ok && data.message.includes('successful')) {
                        showGlobalMessage('Login successful! Redirecting...', 'success');

                        // Store user data in localStorage
                        localStorage.setItem('userData', JSON.stringify(data));

                        // Redirect based on role
                        const userRole = data.role?.toLowerCase() || 'user';
                        const redirectUrl = REDIRECTS[userRole] || 'profile.html';
                        setTimeout(() => { window.location.href = redirectUrl; }, 1200);
                    } else {
                        showGlobalMessage(data.message || 'Login failed. Check your credentials.', 'error');
                    }
                }
            } catch (err) {
                showGlobalMessage('Network error. Try again later.', 'error');
            } finally {
                setButtonLoading(loginBtn, false);
            }
        });

        // ---- Register submit ----
        const registerFormEl = qs('#registerForm');
        registerFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();

            hideGlobalMessage();
            const { ok, values } = validateRegisterForm();
            const registerBtn = qs('#registerForm button[type="submit"]');

            if (!ok) {
                if (successMessage.style.display !== 'block') {
                    showGlobalMessage('Please fix the highlighted fields.', 'error');
                }
                return;
            }

            setButtonLoading(registerBtn, true);

            try {
                const response = await fetch(`${API_BASE}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(values)
                });
                const data = await response.json().catch(() => ({}));

                if (response.ok && data.message.includes('successful')) {
                    showGlobalMessage('Registration successful! Logging in...', 'success');

                    // Auto-login after register
                    const loginResponse = await fetch(`${API_BASE}/api/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: values.email, password: values.password })
                    });
                    const loginData = await loginResponse.json().catch(() => ({}));

                    if (loginResponse.ok && loginData.message.includes('successful')) {
                        // Store user data
                        localStorage.setItem('userData', JSON.stringify(loginData));

                        // Redirect based on role
                        const userRole = loginData.role?.toLowerCase() || 'user';
                        const redirectUrl = REDIRECTS[userRole] || 'profile.html';
                        setTimeout(() => { window.location.href = redirectUrl; }, 1200);
                    } else {
                        showGlobalMessage(loginData.message || 'Auto-login failed. Please log in manually.', 'error');
                        setTimeout(() => showForm('login'), 1200);
                    }
                } else {
                    showGlobalMessage(data.message || 'Registration failed. Try again.', 'error');
                }
            } catch (err) {
                showGlobalMessage('Network error. Try again later.', 'error');
            } finally {
                setButtonLoading(registerBtn, false);
            }
        });

        // ---- Real-time validation ----
        qsa('#loginForm input').forEach(input => {
            input.addEventListener('input', () => {
                if (input.type === 'email') {
                    clearFieldError(input);
                    if (input.value && !isValidEmail(sanitize(input.value))) {
                        setFieldError(input, 'Please enter a valid email address.');
                    }
                } else if (input.type === 'password') {
                    clearFieldError(input);
                    if (!sanitize(input.value)) {
                        setFieldError(input, 'Password is required.');
                    }
                }
            });
        });

        qsa('#registerForm input:not([type="checkbox"])').forEach(input => {
            input.addEventListener('input', () => {
                const ph = input.getAttribute('placeholder') || '';
                clearFieldError(input);
                const val = sanitize(input.value);

                if (ph === 'Full Name' && val && !isValidFullName(val)) {
                    setFieldError(input, 'Enter your full name (letters only, 2–60 chars).');
                }
                if (ph === 'Email Address' && val && !isValidEmail(val)) {
                    setFieldError(input, 'Please enter a valid email address.');
                }
                if (ph === 'NIC Number' && val && !isValidNIC(val)) {
                    setFieldError(input, 'NIC must be 9 digits + V/X or 12 digits.');
                }
                if (ph === 'Phone Number' && val && !isValidPhone(val)) {
                    setFieldError(input, 'Phone must be 10–15 digits.');
                }
                if (ph === 'Password') {
                    const check = passwordStrength(val);
                    if (val && !check.valid) {
                        setFieldError(input, `Password needs: ${check.errors.join(', ')}.`);
                    }
                    const confirmEl = qs('#registerForm input[placeholder="Confirm Password"]');
                    if (confirmEl && sanitize(confirmEl.value) && sanitize(confirmEl.value) !== val) {
                        setFieldError(confirmEl, 'Passwords do not match.');
                    } else if (confirmEl) {
                        clearFieldError(confirmEl);
                    }
                }
                if (ph === 'Confirm Password') {
                    const pwEl = qs('#registerForm input[placeholder="Password"]');
                    if (pwEl && val && val !== sanitize(pwEl.value)) {
                        setFieldError(input, 'Passwords do not match.');
                    }
                }
            });
        });

        // ---- Initialize login form ----
        showForm('login');
    })();
</script>
</body>
</html>